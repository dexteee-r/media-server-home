# Docker Compose Stack - Machine #2 INTRANET

version: '3.8'

# =============================================================================
# SERVICES INTRANET (LAN Privé)
# Machine #2 : Custom PC (i7-6700, 16 GB RAM, GTX 980, 4 TB HDD)
# Rôle : Stockage Famille + Services + VMs Lab
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Immich - Gestion Photos Famille
  # ---------------------------------------------------------------------------
  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich
    restart: unless-stopped
    ports:
      - "2283:3001"
    volumes:
      - /mnt/photos:/usr/src/app/upload  # NFS mount 4 TB
      - ./immich/config:/config
    environment:
      - DB_HOSTNAME=postgres
      - DB_DATABASE_NAME=immich
      - DB_USERNAME=immich
      - DB_PASSWORD=${POSTGRES_PASSWORD_IMMICH}
      - REDIS_HOSTNAME=redis
      - LOG_LEVEL=log
      - TZ=Europe/Brussels
    depends_on:
      - postgres
      - redis
    networks:
      - intranet
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  immich-microservices:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-microservices
    restart: unless-stopped
    command: ['start.sh', 'microservices']
    volumes:
      - /mnt/photos:/usr/src/app/upload
      - ./immich/config:/config
    environment:
      - DB_HOSTNAME=postgres
      - DB_DATABASE_NAME=immich
      - DB_USERNAME=immich
      - DB_PASSWORD=${POSTGRES_PASSWORD_IMMICH}
      - REDIS_HOSTNAME=redis
      - TZ=Europe/Brussels
    depends_on:
      - postgres
      - redis
    networks:
      - intranet

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-ml
    restart: unless-stopped
    volumes:
      - ./immich/model-cache:/cache
    environment:
      - TZ=Europe/Brussels
    networks:
      - intranet

  # ---------------------------------------------------------------------------
  # Nextcloud - Partage Fichiers
  # ---------------------------------------------------------------------------
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - /mnt/files:/var/www/html/data  # NFS mount 4 TB
      - ./nextcloud/config:/var/www/html/config
      - ./nextcloud/custom_apps:/var/www/html/custom_apps
      - ./nextcloud/themes:/var/www/html/themes
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD_NEXTCLOUD}
      - REDIS_HOST=redis
      - NEXTCLOUD_TRUSTED_DOMAINS=files.elmzn.be 192.168.1.101
      - OVERWRITEPROTOCOL=https
      - TZ=Europe/Brussels
    depends_on:
      - postgres
      - redis
    networks:
      - intranet
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ---------------------------------------------------------------------------
  # PostgreSQL - Base de Données
  # ---------------------------------------------------------------------------
  postgres:
    image: tensorchord/pgvecto-rs:pg16-v0.2.0
    container_name: postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD_ROOT}
      - POSTGRES_MULTIPLE_DATABASES=immich,nextcloud
    networks:
      - intranet
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # Redis - Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - intranet
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # Prometheus - Collecte Métriques
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - intranet
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ---------------------------------------------------------------------------
  # Grafana - Dashboards Monitoring
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://grafana.elmzn.be
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - TZ=Europe/Brussels
    depends_on:
      - prometheus
    networks:
      - intranet
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ---------------------------------------------------------------------------
  # Node Exporter - Métriques Système
  # ---------------------------------------------------------------------------
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - intranet

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  intranet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16

# =============================================================================
# NOTES D'UTILISATION
# =============================================================================

# Prérequis :
#   - NFS mounts configurés : /mnt/photos, /mnt/files, /mnt/backups
#   - Fichier .env avec passwords configuré
#   - ZFS pool data-pool créé et monté

# Créer fichier .env :
#   cp .env.example .env
#   nano .env  # Modifier les passwords

# Démarrer stack :
#   docker-compose up -d

# Voir logs :
#   docker-compose logs -f immich
#   docker-compose logs -f nextcloud

# Arrêter stack :
#   docker-compose down

# Backup PostgreSQL :
#   docker exec postgres pg_dumpall -U postgres > backup.sql

# Restore PostgreSQL :
#   docker exec -i postgres psql -U postgres < backup.sql

# Accès Web UI :
#   - Immich : http://192.168.1.101:2283
#   - Nextcloud : http://192.168.1.101:8080
#   - Grafana : http://192.168.1.101:3000
#   - Prometheus : http://192.168.1.101:9090

# Accès externe (via reverse proxy Machine #1) :
#   - https://photos.elmzn.be → Immich
#   - https://files.elmzn.be → Nextcloud
#   - https://grafana.elmzn.be → Grafana

# Monitoring santé containers :
#   docker-compose ps
#   docker stats

# Mise à jour images :
#   docker-compose pull
#   docker-compose up -d
